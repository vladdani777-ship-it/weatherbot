name: Send Weather to Telegram

on:
  schedule:
    - cron: "0 5 * * *"   # 05:00 UTC = 07:00 Europe/Warsaw
  workflow_dispatch:

jobs:
  weather:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Get weather and build message
        id: wx
        env:
          LAT: ${{ vars.LAT }}
          LON: ${{ vars.LON }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          set -e
          LAT=${LAT:-52.2297}
          LON=${LON:-21.0122}

          RES=$(curl -s "https://api.openweathermap.org/data/2.5/weather?lat=$LAT&lon=$LON&units=metric&lang=ru&appid=${OPENWEATHER_API_KEY}")

          TEMP=$(echo "$RES" | jq -r '.main.temp | floor')
          FEELS=$(echo "$RES" | jq -r '.main.feels_like | round')
          DESC=$(echo "$RES" | jq -r '.weather[0].description')
          WIND=$(echo "$RES" | jq -r '.wind.speed')
          HUM=$(echo "$RES" | jq -r '.main.humidity')
          CITY=$(echo "$RES" | jq -r '.name')

          TEXT=$(cat <<EOF
ðŸŒ¤ *ÐŸÐ¾Ð³Ð¾Ð´Ð°: ${CITY:-Ð’Ð°Ñˆ Ð³Ð¾Ñ€Ð¾Ð´}*
$DESC
Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: *$TEMPÂ°C* (Ð¾Ñ‰ÑƒÑ‰Ð°ÐµÑ‚ÑÑ ÐºÐ°Ðº $FEELSÂ°C)
Ð’ÐµÑ‚ÐµÑ€: $WIND Ð¼/Ñ â€¢ Ð’Ð»Ð°Ð¶Ð½Ð¾ÑÑ‚ÑŒ: $HUM%
EOF
)
          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -e
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode text="${{ steps.wx.outputs.text }}"
