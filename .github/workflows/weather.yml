name: Weather to Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"   # 05:00 UTC = 07:00 Warsaw

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      LAT: ${{ vars.LAT }}
      LON: ${{ vars.LON }}
      OWM: ${{ secrets.OPENWEATHER_API_KEY }}
      TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Send weather
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq

          LAT=${LAT:-52.2297}
          LON=${LON:-21.0122}

          RES=$(curl -s "https://api.openweathermap.org/data/2.5/weather?lat=$LAT&lon=$LON&units=metric&lang=ru&appid=${OWM}")

          TEMP=$(echo "$RES" | jq -r '.main.temp | floor')
          FEELS=$(echo "$RES" | jq -r '.main.feels_like | round')
          DESC=$(echo "$RES" | jq -r '.weather[0].description')
          WIND=$(echo "$RES" | jq -r '.wind.speed')
          HUM=$(echo "$RES" | jq -r '.main.humidity')
          CITY=$(echo "$RES" | jq -r '.name')

          TEXT="üå§ *–ü–æ–≥–æ–¥–∞: ${CITY:-–í–∞—à –≥–æ—Ä–æ–¥}*
${DESC}
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: *${TEMP}¬∞C* (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ ${FEELS}¬∞C)
–í–µ—Ç–µ—Ä: ${WIND} –º/—Å ‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${HUM}%"

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d parse_mode="Markdown" \
            --data-urlencode text="$TEXT"
