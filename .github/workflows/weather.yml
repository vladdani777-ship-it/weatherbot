name: Weather to Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *" # 05:00 UTC = 07:00 Warsaw

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      LAT: ${{ vars.LAT }}
      LON: ${{ vars.LON }}
      OWM: ${{ secrets.OPENWEATHER_API_KEY }}
      TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Send weather
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq

          LAT=${LAT:-52.2297}
          LON=${LON:-21.0122}

          RES=$(curl -s "https://api.openweathermap.org/data/2.5/weather?lat=$LAT&lon=$LON&units=metric&lang=ru&appid=${OWM}")

          TEMP=$(echo "$RES" | jq -r '.main.temp | floor')
          FEELS=$(echo "$RES" | jq -r '.main.feels_like | round')
          DESC=$(echo "$RES" | jq -r '.weather[0].description')
          WIND=$(echo "$RES" | jq -r '.wind.speed')
          HUM=$(echo "$RES" | jq -r '.main.humidity')
          CITY=$(echo "$RES" | jq -r '.name')

          # Собираем текст без эмодзи и Markdown-звёздочек, чтобы исключить YAML-углы
          TEXT=$(printf "Погода: %s\n%s\nТемпература: %s°C (ощущается как %s°C)\nВетер: %s м/с • Влажность: %s%%" "${CITY:-Ваш город}" "$DESC" "$TEMP" "$FEELS" "$WIND" "$HUM")

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            --data-urlencode text="$TEXT"
